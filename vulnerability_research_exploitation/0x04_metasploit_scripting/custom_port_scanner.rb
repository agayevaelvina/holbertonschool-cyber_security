require 'msf/core'

class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::Tcp
  include Msf::Auxiliary::Scanner

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name'        => 'Custom Port Scanner',
        'Description' => 'Scans a range of ports on a target system and identifies open ports',
        'Author'      => ['Your Name'],
        'License'     => MSF_LICENSE
      )
    )

    register_options(
      [
        Opt::RHOSTS,
        OptInt.new('STARTPORT', [true, 'Starting port number', 1]),
        OptInt.new('ENDPORT',   [true, 'Ending port number', 1024])
      ]
    )
  end

  def run_host(ip)
    start_port = datastore['STARTPORT']
    end_port   = datastore['ENDPORT']
    open_ports = []

    print_status("Running module against #{ip}")

    (start_port..end_port).each do |port|
      begin
        connect_timeout = 1
        sock = Rex::Socket::Tcp.create(
          'PeerHost' => ip,
          'PeerPort' => port,
          'Timeout'  => connect_timeout
        )

        if sock
          print_good("#{ip}:#{port} - Port #{port} is open on #{ip}")
          open_ports << port
          sock.close
        end

      rescue Rex::ConnectionError, Rex::ConnectionRefused
        # Port is closed or filtered â€” ignore
      end
    end

    if open_ports.any?
      print_status("#{ip}:#{datastore['ENDPORT']} - Open ports on #{ip}: #{open_ports.join(', ')}")
    else
      print_status("#{ip}:#{datastore['ENDPORT']} - No open ports found")
    end
  end
end
